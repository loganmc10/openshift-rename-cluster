- name: Get current cluster context
  ansible.builtin.command: oc config current-context
  register: current_context
  changed_when: current_context.rc != 0

- name: Get current cluster name
  ansible.builtin.command: oc config view -o jsonpath='{.contexts[?(@.name == "{{ current_context.stdout }}")].context.cluster}'
  register: cluster_name
  changed_when: cluster_name.rc != 0

- name: Get current cluster API URL
  ansible.builtin.command: oc config view -o jsonpath='{.clusters[?(@.name == "{{ cluster_name.stdout }}")].cluster.server}'
  register: cluster_url
  changed_when: cluster_url.rc != 0

- name: Update host address
  when: cluster_url.stdout != "https://api." + domain + ":6443"
  ansible.builtin.command: oc config set clusters.{{ cluster_name.stdout }}.server "{{ 'https://api.' + domain + ':6443' }}"

- name: Check for existing secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: api-secret
    namespace: openshift-config
    validate_certs: false
  register: current_secret
  until: current_secret is not failed

- name: Update API server
  when: current_secret.resources | length | int == 0
  block:
    - name: Create certificate
      ansible.builtin.include_tasks: certs.yaml
      vars:
        prefix: "api"
        secret_name: "api-secret"
        secret_namespace: "openshift-config"

    - name: Patch API server
      kubernetes.core.k8s:
        definition:
          apiVersion: config.openshift.io/v1
          kind: APIServer
          metadata:
            name: cluster
          spec:
            servingCerts:
              namedCertificates:
                - names:
                    - "{{ 'api.' + domain }}"
                  servingCertificate:
                    name: api-secret
        validate_certs: false
        state: present
      register: k8s_result
      until: k8s_result is not failed

    - name: Update certificate authority in kubeconfig # noqa: no-handler
      when: cert_secret.changed
      ansible.builtin.command: oc config set clusters.{{ cluster_name.stdout }}.certificate-authority-data "{{ certificate.certificate | b64encode }}"
